<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Elastic Stack | 墨枫个人博客</title><meta name="author" content="墨枫"><meta name="copyright" content="墨枫"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Elastic Stack官网地址：https:&#x2F;&#x2F;www.elastic.co&#x2F;cn&#x2F; 包含了数据的整合 &#x3D;&gt; 提取 &#x3D;&gt; 存储 &#x3D;&gt; 使用，一整套 各个组件介绍：  beats 套件：从各种不同类型的文件 &#x2F; 应用中采集数据。比如：a, b, c, d, e, aa, bb, cc Logstash:从多个采集器或数据源来抽取 &amp;#x2">
<meta property="og:type" content="article">
<meta property="og:title" content="Elastic Stack">
<meta property="og:url" content="http://example.com/2023/05/03/Elastic-Stack/index.html">
<meta property="og:site_name" content="墨枫个人博客">
<meta property="og:description" content="Elastic Stack官网地址：https:&#x2F;&#x2F;www.elastic.co&#x2F;cn&#x2F; 包含了数据的整合 &#x3D;&gt; 提取 &#x3D;&gt; 存储 &#x3D;&gt; 使用，一整套 各个组件介绍：  beats 套件：从各种不同类型的文件 &#x2F; 应用中采集数据。比如：a, b, c, d, e, aa, bb, cc Logstash:从多个采集器或数据源来抽取 &amp;#x2">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-05-03T15:27:51.294Z">
<meta property="article:modified_time" content="2023-05-03T15:25:18.524Z">
<meta property="article:author" content="墨枫">
<meta property="article:tag" content="星球项目">
<meta name="twitter:card" content="summary"><link rel="shortcut icon" href="/%5Bobject%20Object%5D"><link rel="canonical" href="http://example.com/2023/05/03/Elastic-Stack/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 墨枫","link":"链接: ","source":"来源: 墨枫个人博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Elastic Stack',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-03 23:25:18'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/pageStyle.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="墨枫个人博客" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://tse1-mm.cn.bing.net/th/id/OIP-C.Tli8rxBF2RBOpQg7cLTLIQHaHa?w=209&amp;h=199&amp;c=7&amp;r=0&amp;o=5&amp;dpr=1.3&amp;pid=1.7" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">40</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">墨枫个人博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Elastic Stack</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-03T15:27:51.294Z" title="发表于 2023-05-03 23:27:51">2023-05-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-03T15:25:18.524Z" title="更新于 2023-05-03 23:25:18">2023-05-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2%E5%B9%B3%E5%8F%B0/">聚合搜索平台</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Elastic Stack"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h1 id="Elastic-Stack"><a href="#Elastic-Stack" class="headerlink" title="Elastic Stack"></a>Elastic Stack</h1><p>官网地址：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/">https://www.elastic.co/cn/</a></p>
<p>包含了数据的整合 &#x3D;&gt; 提取 &#x3D;&gt; 存储 &#x3D;&gt; 使用，一整套</p>
<p>各个组件介绍：</p>
<ul>
<li>beats 套件：从各种不同类型的文件 &#x2F; 应用中采集数据。比如：a, b, c, d, e, aa, bb, cc</li>
<li>Logstash:从多个采集器或数据源来抽取 &#x2F; 转换数据，向 ES 输送。比如：a, bb, cc</li>
<li>elasticsearch:存储、查询数据</li>
<li>kibana:可视化 ES 数据</li>
</ul>
<h2 id="安装-ES"><a href="#安装-ES" class="headerlink" title="安装 ES"></a>安装 ES</h2><p>elasticsearch:<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/setup.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/setup.html</a></p>
<p>安装：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/zip-windows.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/zip-windows.html</a></p>
<p><strong>注意：一套技术，版本必须要一致，此处使用 7.17 版本</strong></p>
<h2 id="安装-Kibana"><a href="#安装-Kibana" class="headerlink" title="安装 Kibana"></a>安装 Kibana</h2><p>Kibana:<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/kibana/7.17/introduction.html">https://www.elastic.co/guide/en/kibana/7.17/introduction.html</a></p>
<p>安装：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/kibana/7.17/install.html">https://www.elastic.co/guide/en/kibana/7.17/install.html</a></p>
<h2 id="ElasticSearch-概念"><a href="#ElasticSearch-概念" class="headerlink" title="ElasticSearch 概念"></a>ElasticSearch 概念</h2><p>可以理解为 MySQL 一样的数据库去学习和理解</p>
<p>入门学习：</p>
<ul>
<li>Index 索引 &#x3D;&gt; MySQL 里的表（table）</li>
<li>建表、增删改查（查询需要花费的时间较多）</li>
<li>用客户端去调用 ElasticSearch(3种)</li>
<li>语法：SQL、代码的方法（4中种语法）</li>
</ul>
<p>ES 相比于 MySQL 能够自动帮我们做分词，能够非常高效、灵活地查询内容</p>
<h3 id="索引（倒排索引）"><a href="#索引（倒排索引）" class="headerlink" title="索引（倒排索引）"></a>索引（倒排索引）</h3><p>正向索引：理解为书籍的目录，可以快速找到对应的内容（怎么根据页码找到文章）</p>
<p>倒排索引：怎么根据内容找到文章</p>
<p>文章 A：你好，我是 rapper</p>
<p>文章 B：墨枫你好，我是 coder</p>
<p>切词：</p>
<p>你好，我是，rapper</p>
<p>墨枫，你好，我是，coder</p>
<p>构建倒排索引表：</p>
<table>
<thead>
<tr>
<th>词</th>
<th>内容 id</th>
</tr>
</thead>
<tbody><tr>
<td>你好</td>
<td>文章 A， B</td>
</tr>
<tr>
<td>我是</td>
<td>文章 A， B</td>
</tr>
<tr>
<td>rapper</td>
<td>文章 A</td>
</tr>
<tr>
<td>墨枫</td>
<td>文章 B</td>
</tr>
<tr>
<td>coder</td>
<td>文章 B</td>
</tr>
</tbody></table>
<p>用户搜：“墨枫 rapper”</p>
<p>ES 先切词：墨枫， rapper</p>
<p>然后去倒排索引对应的文章</p>
<h2 id="ES的几种调用方式"><a href="#ES的几种调用方式" class="headerlink" title="ES的几种调用方式"></a>ES的几种调用方式</h2><h3 id="1）restful-api-调用（HTTP-请求）"><a href="#1）restful-api-调用（HTTP-请求）" class="headerlink" title="1）restful api 调用（HTTP 请求）"></a>1）restful api 调用（HTTP 请求）</h3><p>GET请求：<a target="_blank" rel="noopener" href="http://localhost:9200/">http://localhost:9200/</a></p>
<p>curl 可以模拟发送请求：curl -X GET “localhost:9200&#x2F;?pretty”</p>
<p>ES 的启动端口</p>
<ol>
<li>9200：给外部用户（给客户端调用）的端口</li>
<li>9300：给 ES 集群内部通信的（外部调用不了）</li>
</ol>
<h3 id="2-kibana-devtools"><a href="#2-kibana-devtools" class="headerlink" title="2)kibana devtools"></a>2)kibana devtools</h3><p>自由地对 ES 进行操作（本质上也是 restful api)</p>
<p>devtools 不建议生产环境使用</p>
<h3 id="3）客户端调用"><a href="#3）客户端调用" class="headerlink" title="3）客户端调用"></a>3）客户端调用</h3><p>java 客户端、go 客户端等</p>
<p>参考文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/7.17/_getting_started.html">https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/7.17/_getting_started.html</a></p>
<h2 id="ES-语法"><a href="#ES-语法" class="headerlink" title="ES 语法"></a>ES 语法</h2><h3 id="DSL"><a href="#DSL" class="headerlink" title="DSL"></a>DSL</h3><p>json 格式，好理解；额 Http 请求最兼容，应用最广</p>
<h4 id="建表、插入数据"><a href="#建表、插入数据" class="headerlink" title="建表、插入数据"></a>建表、插入数据</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST post/_doc/pqGEzYcB9-HYm7AKfgyO</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;墨枫33333&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;墨枫的描述33333&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h4 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h4><p>DSL 语法：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-dsl.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-dsl.html</a></p>
<p>（随忘随查）</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET post/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;desc&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>根据 id 查询：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET post/_doc/pqGEzYcB9-HYm7AKfgyO</span><br></pre></td></tr></table></figure>



<h4 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST post/_doc/pqGEzYcB9-HYm7AKfgyO</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;墨枫&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;墨枫的描述&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h4 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h4><p>删除普通索引</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE index_name</span><br></pre></td></tr></table></figure>

<p>删除数据流式索引</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE _data_stream/post</span><br></pre></td></tr></table></figure>



<h3 id="EQL"><a href="#EQL" class="headerlink" title="EQL"></a>EQL</h3><p>专门查询 ECS 文档（标准指标文档）的数据的语法，更加规范，但只适用于特定场景（比如事件流）</p>
<p>文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/eql.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/eql.html</a></p>
<p>示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST my_event/_doc</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;墨枫33333&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2099-05-06T16:21:15.000Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;event&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;original&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.0.2.42 - - [06/May/2099:16:21:15 +0000] \&quot;GET /images/bg.jpg HTTP/1.0\&quot; 200 24736&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">GET /my_event/_eql/search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    any where 1 == 1</span></span><br><span class="line"><span class="string">  &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h3><p>文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/sql-getting-started.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/sql-getting-started.html</a></p>
<p>学习成本低，但是可能需要插件支持、<strong>性能较差</strong></p>
<p>示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /_sql?format=txt</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SELECT * FROM post where title like &#x27;墨枫%&#x27;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="Painless-Scripting-language"><a href="#Painless-Scripting-language" class="headerlink" title="Painless Scripting language"></a>Painless Scripting language</h3><p>编程式取值，更灵活，但是学习成本高</p>
<h2 id="Mapping"><a href="#Mapping" class="headerlink" title="Mapping"></a>Mapping</h2><p>文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/explicit-mapping.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/explicit-mapping.html</a></p>
<p>可以理解为数据库的表结构，有哪些字段、字段类型。</p>
<p>ES 支持动态 mapping，表结构可以动态改变，而不像 MySQL 一样必须手动建表，没有的字段就不能插入。</p>
<p>显示创建 mapping：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET user/_mapping</span><br><span class="line">PUT user</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span>    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span>  </span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span>  <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span>  <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span>   <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span>  <span class="punctuation">&#125;</span>     </span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="ElasticStack-概念"><a href="#ElasticStack-概念" class="headerlink" title="ElasticStack 概念"></a>ElasticStack 概念</h2><p>ES 索引（Index） &#x3D;&gt; 表</p>
<p>ES field  (字段) &#x3D;&gt; 列</p>
<p>倒排索引</p>
<p>调用语法（DSL、EQL、SQL等）</p>
<p>Mapping 表结构</p>
<ul>
<li>自动生成 mapping</li>
<li>手动指定 mapping</li>
</ul>
<h3 id="分词器"><a href="#分词器" class="headerlink" title="分词器"></a>分词器</h3><p>内置分词器：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/analysis-analyzers.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/analysis-analyzers.html</a></p>
<p>空格分词器：whitespace，结果 The、quick、brown、fox等</p>
<p>示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;whitespace&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span>     <span class="string">&quot;The quick is brown fox.&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>标准分词规则，结果：is、this、deja、vu</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokenizer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span>  <span class="punctuation">[</span> <span class="string">&quot;lowercase&quot;</span><span class="punctuation">,</span> <span class="string">&quot;asciifolding&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span>      <span class="string">&quot;Is this déja vu?&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>关键词分词器：就是不分词，整句话当作专业术语</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span>     <span class="string">&quot;The quick is brown fox.&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="IK-分词器（ES-插件）"><a href="#IK-分词器（ES-插件）" class="headerlink" title="IK 分词器（ES 插件）"></a>IK 分词器（ES 插件）</h3><p>中文友好：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></p>
<p>下载地址（注意版本一致）：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases/tag/v7.17.7">https://github.com/medcl/elasticsearch-analysis-ik/releases/tag/v7.17.7</a></p>
<p>思考：如何让 IK 按照自己的想法分词？</p>
<p>解决方案：自定义词典</p>
<p>ik_smart 和 ik_max_word 的区别：</p>
<p>举例：“小黑子”</p>
<p>ik_smart 是只能分词，尽量选择最像一个词的拆分方式，比如“小”、“黑子”</p>
<p>ik_max_word 尽可能地分词，可以包括组合词，比如“小黑”、“黑子“</p>
<h3 id="打分机制"><a href="#打分机制" class="headerlink" title="打分机制"></a>打分机制</h3><p>比如有 3 条内容：</p>
<ol>
<li>墨枫是狗</li>
<li>墨枫是小黑子</li>
<li>我是小黑子</li>
</ol>
<p>用户搜索：</p>
<ol>
<li>墨枫，第一条分数最高，因为第一条匹配了关键词，而且更短（匹配比例更大）</li>
<li>墨枫小黑子 &#x3D;&gt; 墨枫、小、黑子，排序结果：2 &gt; 3 &gt; 1</li>
</ol>
<p>参考文章：<a target="_blank" rel="noopener" href="https://liyupi.blog.csdn.net/article/details/119176943">https://liyupi.blog.csdn.net/article/details/119176943</a></p>
<p>官方参考文章：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/guide/master/controlling-relevance.html">https://www.elastic.co/guide/en/elasticsearch/guide/master/controlling-relevance.html</a></p>
<h2 id="ES-调用方式"><a href="#ES-调用方式" class="headerlink" title="ES 调用方式"></a>ES 调用方式</h2><p>有 3 种：</p>
<ol>
<li>HTTP Restful 调用</li>
<li>kibana 操作（dev tools)</li>
<li>客户端操作（Java）</li>
</ol>
<h3 id="Java-操作-ES"><a href="#Java-操作-ES" class="headerlink" title="Java 操作 ES"></a>Java 操作 ES</h3><p>3 种方式：</p>
<p>1）ES 官方的 Java API</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/7.17/introduction.html">https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/7.17/introduction.html</a></p>
<p>快速开始：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/7.17/connecting.html">https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/7.17/connecting.html</a></p>
<p>2）ES 以前的官方 Java API， HighLevelRestClient（已经废弃，不建议使用）</p>
<p>3）Spring Data Elasticsearch（推荐）</p>
<p>spring-data 系列：spring 提供的操作数据的框架</p>
<p>spring-data-redis:操作 Redis 的一套方法</p>
<p>spring-data-mongodb:操作 mongodb 的一套方法</p>
<p>spring-data-elasticsearch:操作 elasticsearch 的一套方法</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-data/elasticsearch/docs/4.4.10/reference/html/">https://docs.spring.io/spring-data/elasticsearch/docs/4.4.10/reference/html/</a></p>
<p>自定义方法：用户可以指定接口的方法名称，框架帮你自动生成查询</p>
<h2 id="用-ES-实现搜索接口"><a href="#用-ES-实现搜索接口" class="headerlink" title="用 ES 实现搜索接口"></a>用 ES 实现搜索接口</h2><h3 id="1、建表（建立索引）"><a href="#1、建表（建立索引）" class="headerlink" title="1、建表（建立索引）"></a>1、建表（建立索引）</h3><p>数据库表结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 帖子表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> post</span><br><span class="line">(</span><br><span class="line">    id         <span class="type">bigint</span> auto_increment comment <span class="string">&#x27;id&#x27;</span> <span class="keyword">primary</span> key,</span><br><span class="line">    title      <span class="type">varchar</span>(<span class="number">512</span>)                       <span class="keyword">null</span> comment <span class="string">&#x27;标题&#x27;</span>,</span><br><span class="line">    content    text                               <span class="keyword">null</span> comment <span class="string">&#x27;内容&#x27;</span>,</span><br><span class="line">    tags       <span class="type">varchar</span>(<span class="number">1024</span>)                      <span class="keyword">null</span> comment <span class="string">&#x27;标签列表（json 数组）&#x27;</span>,</span><br><span class="line">    thumbNum   <span class="type">int</span>      <span class="keyword">default</span> <span class="number">0</span>                 <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;点赞数&#x27;</span>,</span><br><span class="line">    favourNum  <span class="type">int</span>      <span class="keyword">default</span> <span class="number">0</span>                 <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;收藏数&#x27;</span>,</span><br><span class="line">    userId     <span class="type">bigint</span>                             <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;创建用户 id&#x27;</span>,</span><br><span class="line">    createTime datetime <span class="keyword">default</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    updateTime datetime <span class="keyword">default</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">on</span> <span class="keyword">update</span> <span class="built_in">CURRENT_TIMESTAMP</span> comment <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">    isDelete   tinyint  <span class="keyword">default</span> <span class="number">0</span>                 <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;是否删除&#x27;</span>,</span><br><span class="line">    index idx_userId (userId)</span><br><span class="line">) comment <span class="string">&#x27;帖子&#x27;</span> <span class="keyword">collate</span> <span class="operator">=</span> utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure>



<p>ES Mapping:</p>
<p>id（可以不放到字段设置里）</p>
<p>ES 中，尽量存放需要用户筛选（搜索）的数据</p>
<ul>
<li>aliases:别名（为了后续方便数据迁移）</li>
</ul>
<p>​		字段类型时 text，这个字段是可被分词的、可模糊查询的；而如果是 keyword，只能完全匹配、精确查询。</p>
<ul>
<li><p>analyzer （存储时生效的分词器）:用 ik_max_word ，拆的更碎、索引更多，更有可能被搜索出来</p>
</li>
<li><p>search_analyzer (查询时生效的分词器)：用 ik_smart ,更偏向于用户想搜的分词</p>
</li>
</ul>
<p>如果想让 text 类型的分词字段也支持精确查询，可以创建 keyword 类型的子字段：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;keyword&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ignore_above&quot;</span><span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>建表结构：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">PUT post_v1</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;aliases&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;post&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;keyword&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span><span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;keyword&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span><span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;createTime&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;updateTime&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;isDelete&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="2、增删改查"><a href="#2、增删改查" class="headerlink" title="2、增删改查"></a>2、增删改查</h3><p>第一种方式：ElasticsearchRepository&lt;PostEsDTO, Long&gt;, 默认提供了简单的增删改查，多用于可预期的、相对诶那么复杂的查询、自定义查询，返回结果相对简单直接。</p>
<p>接口代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CrudRepository</span>&lt;T, ID&gt; <span class="keyword">extends</span> <span class="title class_">Repository</span>&lt;T, ID&gt; &#123;</span><br><span class="line"></span><br><span class="line">	&lt;S <span class="keyword">extends</span> <span class="title class_">T</span>&gt; S <span class="title function_">save</span><span class="params">(S entity)</span>;</span><br><span class="line"></span><br><span class="line">	&lt;S <span class="keyword">extends</span> <span class="title class_">T</span>&gt; Iterable&lt;S&gt; <span class="title function_">saveAll</span><span class="params">(Iterable&lt;S&gt; entities)</span>;</span><br><span class="line"></span><br><span class="line">	Optional&lt;T&gt; <span class="title function_">findById</span><span class="params">(ID id)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">existsById</span><span class="params">(ID id)</span>;</span><br><span class="line"></span><br><span class="line">	Iterable&lt;T&gt; <span class="title function_">findAll</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	Iterable&lt;T&gt; <span class="title function_">findAllById</span><span class="params">(Iterable&lt;ID&gt; ids)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">long</span> <span class="title function_">count</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(ID id)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(T entity)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">deleteAllById</span><span class="params">(Iterable&lt;? extends ID&gt; ids)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">deleteAll</span><span class="params">(Iterable&lt;? extends T&gt; entities)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">deleteAll</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ES 中，_开头的字段表示系统默认字段，比如 _id,如果系统不指定，会自动生成。但是不会在 _source 字段中补充id 的值，所以建议手动指定。</p>
<p>支持根据方法名自动生成方法，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;PostEsDTO&gt; <span class="title function_">findByTitle</span><span class="params">(String title)</span>;</span><br></pre></td></tr></table></figure>



<p>第二种方式：Spring 默认给我们提供的操作 ES 的客户端对象 ElasticsearchRestTemplate ，也提供了增删改查，它的增删改查更灵活，适用于更复杂的操作，返回结果更完整，但需要自己解析。</p>
<p><strong>对于复杂的查询，建议使用第二种方式</strong></p>
<p>三个步骤：</p>
<ol>
<li>取参数</li>
<li>把参数组合为 ES 支持的搜索条件</li>
<li>从返回值中取结果</li>
</ol>
<h3 id="3、查询-DSL"><a href="#3、查询-DSL" class="headerlink" title="3、查询 DSL"></a>3、查询 DSL</h3><p>参考文档：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-filter-context.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-filter-context.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-dsl-bool-query.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-dsl-bool-query.html</a></li>
</ul>
<p>示例代码：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET post/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;墨枫&quot;</span>        <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span>   <span class="string">&quot;博客&quot;</span>        <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> </span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;term&quot;</span><span class="punctuation">:</span>  <span class="punctuation">&#123;</span> <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;published&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;publish_date&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-05-02&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>wilcard 模糊查询</p>
<p>regexp 正则表达式</p>
<p>查询结果中，score 代码匹配分数</p>
<p>建议先测试 DSL，再翻译成 Java</p>
<p>动静分离设计：先模糊筛选竟然数据，查出数据后，再根据查到的内容 id 去数据库查找到 <strong>动态数据</strong></p>
<h2 id="数据同步"><a href="#数据同步" class="headerlink" title="数据同步"></a>数据同步</h2><p>一般情况下，如果做查询搜索功能，使用 ES 来模糊查询，但是数据是存放在数据库 MySQL 里的，所以说需要把 MySQL 的数据和 ES 的数据进行同步，保证数据的一致性（以 MySQL为主）</p>
<p>MySQL &#x3D;&gt; ES （单向）</p>
<p>首次安装完 ES ，把 MySQL数据全量同步到 ES 里，写一个单词脚本</p>
<p>4 种方式，全量同步（首次） + 增量同步（新数据）：</p>
<ol>
<li>定时任务，比如 1 分钟 1 次，找到 MySQL 过去几分钟内（至少定时周期的 2 倍）发生改变的数据，然后更新到 ES<br>优点：简单易懂、占用资源少、不用引入第三方中间件<br>缺点：有时间差<br>应用场景：数据短时间内不同步影响不大、或者数据几乎不发生修改</li>
<li>双写：写数据的时候，必须也去写 ES；更新删除数据库同理。（事务：建议先保证 MySQL 写成功，如果 ES 写失败了，可以通过定时任务 + 日志 + 告警进行检测和修复（补偿）</li>
<li>用 Logstash 数据同步管道（一般要配合 kafka 消息队列 + beats 采集器）</li>
<li>Canal 监听 MySQL Binlog, 实时同步</li>
</ol>
<h3 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h3><p><strong>传输</strong>和<strong>处理</strong>数据的管道</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/7.17/getting-started-with-logstash.html">https://www.elastic.co/guide/en/logstash/7.17/getting-started-with-logstash.html</a></p>
<p>好处：用起来方便，插件多</p>
<p>缺点：成本更大、一般要配合其他组件使用（比如 kafka)</p>
<p><img src="C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\image-20230503223832634.png" alt="image-20230503223832634"></p>
<p>事件 DEMO：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> logstash-7.17.9</span><br><span class="line">.\bin\logstash.bat -e <span class="string">&quot;input &#123; stdin &#123;&#125; &#125; output &#123; stdout&#123;&#125; &#125;&quot;</span> </span><br></pre></td></tr></table></figure>



<p>快速开始文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/7.17/running-logstash-windows.html">https://www.elastic.co/guide/en/logstash/7.17/running-logstash-windows.html</a></p>
<p>监听 udp 并输出：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">input&#123;</span><br><span class="line">    udp&#123;</span><br><span class="line">        <span class="attribute">port</span> =&gt; <span class="number">514</span></span><br><span class="line">        type =&gt; <span class="string">&quot;syslog&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output&#123;</span><br><span class="line">    stdout&#123;</span><br><span class="line">        <span class="attribute">codec</span> =&gt; rubydebug</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>要把 MySQL 同步给 Elasticsearch</p>
<p>问题1：找不到 mysql 包</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Error:unable to load mysql-connector-java-<span class="number">5.1</span><span class="number">.36</span>-bin.jar from :jdbc_driver_library,file not <span class="title function_">readable</span></span><br><span class="line"><span class="params">(please check user and group permissions <span class="keyword">for</span> the path)</span></span><br><span class="line">Exception:LogStash:PluginLoadingError</span><br></pre></td></tr></table></figure>

<p>解决：修改 Logstash 任务配置中的 jdbc_driver_library 为驱动包的绝对路径（驱动包可以从 maven 仓库中拷贝）</p>
<p>增量配置：是不是可以只查最新更新的数据？可以记录上次更新的时间，只查出来 &gt; 该更新时间的数据</p>
<p>小知识：预编译 SQL 的优点</p>
<ol>
<li>灵活</li>
<li>模板好懂</li>
<li>快（有缓存）</li>
<li>部分仿注入</li>
</ol>
<p>sql_last_value 是上次查到额数据的最后一行的指定的字段，如果要全量更新，只要删除掉</p>
<p>D:\javaTools\ElasticStack\logstash-7.17.9\data\plugins\inputs\jdbc\logstash_jdbc_last_run 文件即可（这个文件存储额上次同步到的数据）</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">input</span> &#123;</span><br><span class="line">  <span class="section">jdbc</span> &#123;</span><br><span class="line">    <span class="attribute">jdbc_driver_library</span> =&gt; <span class="string">&quot;D:\javaTools\ElasticStack\logstash-7.17.9\config\mysql-connector-java-8.0.29.jar&quot;</span></span><br><span class="line">    jdbc_driver_class =&gt; <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span></span><br><span class="line">    jdbc_connection_string =&gt; <span class="string">&quot;jdbc:mysql://localhost:3306/my_db&quot;</span></span><br><span class="line">    jdbc_user =&gt; <span class="string">&quot;root&quot;</span></span><br><span class="line">	jdbc_password =&gt; <span class="string">&quot;root&quot;</span></span><br><span class="line">    statement =&gt; <span class="string">&quot;SELECT * from post where updateTime &gt; :sql_last_value&quot;</span></span><br><span class="line">	use_column_value =&gt; <span class="literal">true</span></span><br><span class="line">    tracking_column_type =&gt; <span class="string">&quot;timestamp&quot;</span></span><br><span class="line">    tracking_column =&gt; <span class="string">&quot;updatetime&quot;</span></span><br><span class="line">	parameters =&gt; &#123; &quot;favorite_artist&quot; =&gt; &quot;Beethoven&quot; &#125;</span><br><span class="line">    <span class="attribute">schedule</span> =&gt; <span class="string">&quot;*/5 * * * *&quot;</span></span><br><span class="line">	jdbc_default_timezone =&gt; <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="section">stdout</span> &#123; <span class="attribute">codec</span> =&gt; rubydebug &#125;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">		<span class="attribute">hosts</span> =&gt; <span class="string">&quot;http://localhost:9200&quot;</span></span><br><span class="line">		index =&gt; <span class="string">&quot;post_v1&quot;</span></span><br><span class="line">		document_id =&gt; <span class="string">&quot;%&#123;id&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>注意查询语句中要按 updateTime 排序，保证最后一条是最大的：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">input</span> &#123;</span><br><span class="line">  <span class="section">jdbc</span> &#123;</span><br><span class="line">    <span class="attribute">jdbc_driver_library</span> =&gt; <span class="string">&quot;D:\javaTools\ElasticStack\logstash-7.17.9\config\mysql-connector-java-8.0.29.jar&quot;</span></span><br><span class="line">    jdbc_driver_class =&gt; <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span></span><br><span class="line">    jdbc_connection_string =&gt; <span class="string">&quot;jdbc:mysql://localhost:3306/my_db&quot;</span></span><br><span class="line">    jdbc_user =&gt; <span class="string">&quot;root&quot;</span></span><br><span class="line">	jdbc_password =&gt; <span class="string">&quot;root&quot;</span></span><br><span class="line">    statement =&gt; <span class="string">&quot;SELECT * from post where updateTime &gt; :sql_last_value and updateTime &lt; now() order by updateTime desc&quot;</span></span><br><span class="line">	use_column_value =&gt; <span class="literal">true</span></span><br><span class="line">    tracking_column_type =&gt; <span class="string">&quot;timestamp&quot;</span></span><br><span class="line">    tracking_column =&gt; <span class="string">&quot;updatetime&quot;</span></span><br><span class="line">	parameters =&gt; &#123; &quot;favorite_artist&quot; =&gt; &quot;Beethoven&quot; &#125;</span><br><span class="line">    <span class="attribute">schedule</span> =&gt; <span class="string">&quot;*/5 * * * *&quot;</span></span><br><span class="line">	jdbc_default_timezone =&gt; <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="section">stdout</span> &#123; <span class="attribute">codec</span> =&gt; rubydebug &#125;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">		<span class="attribute">hosts</span> =&gt; <span class="string">&quot;http://localhost:9200&quot;</span></span><br><span class="line">		index =&gt; <span class="string">&quot;post_v1&quot;</span></span><br><span class="line">		document_id =&gt; <span class="string">&quot;%&#123;id&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>两个问题：</p>
<ol>
<li>字段全变成小写了</li>
<li>多了一些我们不想同步的字段</li>
</ol>
<p>解决：</p>
<p>编写过滤</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">input</span> &#123;</span><br><span class="line">  <span class="section">jdbc</span> &#123;</span><br><span class="line">    <span class="attribute">jdbc_driver_library</span> =&gt; <span class="string">&quot;D:\javaTools\ElasticStack\logstash-7.17.9\config\mysql-connector-java-8.0.29.jar&quot;</span></span><br><span class="line">    jdbc_driver_class =&gt; <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span></span><br><span class="line">    jdbc_connection_string =&gt; <span class="string">&quot;jdbc:mysql://localhost:3306/my_db&quot;</span></span><br><span class="line">    jdbc_user =&gt; <span class="string">&quot;root&quot;</span></span><br><span class="line">	jdbc_password =&gt; <span class="string">&quot;root&quot;</span></span><br><span class="line">    statement =&gt; <span class="string">&quot;SELECT * from post where updateTime &gt; :sql_last_value and updateTime &lt; now() order by updateTime desc&quot;</span></span><br><span class="line">	use_column_value =&gt; <span class="literal">true</span></span><br><span class="line">    tracking_column_type =&gt; <span class="string">&quot;timestamp&quot;</span></span><br><span class="line">    tracking_column =&gt; <span class="string">&quot;updatetime&quot;</span></span><br><span class="line">	parameters =&gt; &#123; &quot;favorite_artist&quot; =&gt; &quot;Beethoven&quot; &#125;</span><br><span class="line">    <span class="attribute">schedule</span> =&gt; <span class="string">&quot;*/5 * * * *&quot;</span></span><br><span class="line">	jdbc_default_timezone =&gt; <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="section">mutate</span> &#123;</span><br><span class="line">        <span class="attribute">rename</span> =&gt; &#123;</span><br><span class="line">			&quot;updatetime&quot; =&gt; &quot;updateTime&quot;</span><br><span class="line">			&quot;userid&quot; =&gt; &quot;userId&quot;</span><br><span class="line">			&quot;createtime&quot; =&gt; &quot;createTime&quot;</span><br><span class="line">			&quot;isdelete&quot; =&gt; &quot;isDelete&quot;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="attribute">remove_field</span> =&gt; [<span class="string">&quot;thumbnum&quot;</span>, <span class="string">&quot;favournum&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="section">stdout</span> &#123; <span class="attribute">codec</span> =&gt; rubydebug &#125;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">		<span class="attribute">hosts</span> =&gt; <span class="string">&quot;http://localhost:9200&quot;</span></span><br><span class="line">		index =&gt; <span class="string">&quot;post_v1&quot;</span></span><br><span class="line">		document_id =&gt; <span class="string">&quot;%&#123;id&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="订阅数据库流水的同步方式-Canal"><a href="#订阅数据库流水的同步方式-Canal" class="headerlink" title="订阅数据库流水的同步方式 Canal"></a>订阅数据库流水的同步方式 Canal</h3><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/canal/">https://github.com/alibaba/canal/</a></p>
<p>优点：实时同步，实时性非常强</p>
<p>原理：数据库每次修改时，会修改 binlog 文件，只要监听该文件的修改，就能第一时间饿到消息并处理</p>
<p>canal：帮你监听 binlog，并解析 binlog 为可以理解的内容</p>
<p>它伪装成了 MySQL 的从节点，获取主节点给的 binlog ,如图：</p>
<p><img src="C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\image-20230503230056433.png" alt="image-20230503230056433"></p>
<p>快速开始：<a target="_blank" rel="noopener" href="https://github.com/alibaba/canal/wiki/QuickStart">https://github.com/alibaba/canal/wiki/QuickStart</a></p>
<p>对于自建 MySQL , 需要先开启 Binlog 写入功能，配置 binlog-format 为 ROW 模式，my.cnf 中配置如下</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">log-bin</span>=<span class="string">mysql-bin # 开启 binlog</span></span><br><span class="line"><span class="attr">binlog-format</span>=<span class="string">ROW # 选择 ROW 模式</span></span><br><span class="line"><span class="attr">server_id</span>=<span class="string">1 # 配置 MySQL replaction 需要定义，不要和 canal 的 slaveId 重复</span></span><br></pre></td></tr></table></figure>



<p>如果 java 找不到，修改 startup.bat 脚本为你自己的 java home：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> JAVA_HOME=C:\Users\59278\.jdks\corretto-1.8.0_302</span><br><span class="line"><span class="built_in">echo</span> %JAVA_HOME%</span><br><span class="line"><span class="built_in">set</span> PATH=%JAVA_HOME%\bin;%PATH%</span><br><span class="line"><span class="built_in">echo</span> %PATH%</span><br></pre></td></tr></table></figure>



<p>问题：mysql 无法链接，Caused by: java.io.IOException: caching_sha2_password Auth failed</p>
<p>解决方案：<a target="_blank" rel="noopener" href="https://github.com/alibaba/canal/issues/3902">https://github.com/alibaba/canal/issues/3902</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ALTER USER &#x27;canal&#x27;@&#x27;%&#x27; IDENTIFIED WITH mysql_native_password BY &#x27;canal&#x27;;</span><br><span class="line"></span><br><span class="line">ALTER USER &#x27;canal&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;canal&#x27; PASSWORD EXPIRE NEVER;</span><br><span class="line"></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>



<h2 id="配置-kibama-可视化看板"><a href="#配置-kibama-可视化看板" class="headerlink" title="配置 kibama 可视化看板"></a>配置 kibama 可视化看板</h2><ol>
<li>创建索引</li>
<li>导入数据</li>
<li>创建索引模式</li>
<li>选择图表、托拉拽</li>
<li>保存</li>
</ol>
<h2 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h2><p>官方文档：<a target="_blank" rel="noopener" href="https://jmeter.apache.org/">https://jmeter.apache.org/</a></p>
<p>找到 jar 包：D:\javaTools\apache-jmeter-5.5\bin\ApacheJMeter.jar 启动</p>
<p>配置线程组 &#x3D;&gt; 请求头 &#x3D;&gt; 默认请求 &#x3D;&gt; 单个请求头 &#x3D;&gt; 响应断言 &#x3D;&gt; 聚合报告 &#x2F; 结果树</p>
<p><img src="C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\image-20230503230921181.png" alt="image-20230503230921181"></p>
<p>99% 分位：99% 的用户都在这个响应时间内</p>
<p>吞吐量：每秒处理的请求数 qps</p>
<h3 id="更多的学习"><a href="#更多的学习" class="headerlink" title="更多的学习"></a>更多的学习</h3><p>插件：<a target="_blank" rel="noopener" href="https://jmeter-plugins.org/install/Install/">https://jmeter-plugins.org/install/Install/</a></p>
<p>下载后文件为 plugins-manager.jar 格式，将其放入 jmeter 安装目录下的 lib&#x2F;ext 目录，然后 jmeter,即可。</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45189665/article/details/125278218">https://blog.csdn.net/weixin_45189665/article/details/125278218</a></p>
<h2 id="搜索建议"><a href="#搜索建议" class="headerlink" title="搜索建议"></a>搜索建议</h2><p>参考官方文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/search-suggesters.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/search-suggesters.html</a></p>
<p>示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET post/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;墨枫是狗&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pre_tags&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;&lt;h1&gt;&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;post_tags&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;&lt;h1&gt;&quot;</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;suggest&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;my-suggestion&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;text&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;墨枫是狗&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;term&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;content&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="搜索高亮"><a href="#搜索高亮" class="headerlink" title="搜索高亮"></a>搜索高亮</h2><p>参考官方：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/highlighting.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/highlighting.html</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET post/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;鱼皮是狗&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pre_tags&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;&lt;h1&gt;&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;post_tags&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;&lt;h1&gt;&quot;</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="前端防抖节流"><a href="#前端防抖节流" class="headerlink" title="前端防抖节流"></a>前端防抖节流</h2><p>问题：用户频繁搜索、频繁点击欧索按钮怎么办？</p>
<p>解决：使用 lodash 工具库实现防抖和节流</p>
<p>节流：每段时间最多执行 x 次（比如服务器限流）<a target="_blank" rel="noopener" href="https://www.lodashjs.com/docs/lodash.throttle">https://www.lodashjs.com/docs/lodash.throttle</a></p>
<p>防抖：等待一段时间内没有其他操作了，才执行操作（比如输入搜索）</p>
<p><a target="_blank" rel="noopener" href="https://www.lodashjs.com/docs/lodash.debounce">https://www.lodashjs.com/docs/lodash.debounce</a></p>
<h2 id="接口稳定性优化"><a href="#接口稳定性优化" class="headerlink" title="接口稳定性优化"></a>接口稳定性优化</h2><p>问题：调用第三方接口不稳定怎么办？（比如 bing 接口）</p>
<p>使用 guava-retrying 库实现自动重试：<a target="_blank" rel="noopener" href="https://github.com/rholder/guava-retrying">https://github.com/rholder/guava-retrying</a></p>
<p>参考学习文章：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1752086">https://cloud.tencent.com/developer/article/1752086</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">墨枫</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/05/03/Elastic-Stack/">http://example.com/2023/05/03/Elastic-Stack/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">墨枫个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%98%9F%E7%90%83%E9%A1%B9%E7%9B%AE/">星球项目</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/05/03/%E4%BA%8C%E3%80%81%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2%E5%B9%B3%E5%8F%B0%E6%95%B0%E6%8D%AE%E6%8A%93%E5%8F%96/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">二、聚合搜索平台数据抓取</div></div></a></div><div class="next-post pull-right"><a href="/2023/04/12/%E8%AF%BB%E3%80%8A%E9%9C%8D%E4%B9%B1%E6%97%B6%E6%9C%9F%E7%9A%84%E7%88%B1%E6%83%85%E3%80%8B/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">读《霍乱时期的爱情》</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/12/22/GateWay-%E8%BD%AC%E5%8F%91%E8%AF%B7%E6%B1%82/" title="GateWay 转发请求"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-22</div><div class="title">GateWay 转发请求</div></div></a></div><div><a href="/2022/12/22/%E4%B8%80%E3%80%81API%20%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0%E8%AE%BE%E8%AE%A1/" title="API 开放平台设计"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-22</div><div class="title">API 开放平台设计</div></div></a></div><div><a href="/2022/12/22/%E4%BA%8C%E3%80%81API%20%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0-%E6%A8%A1%E6%8B%9F%E6%8E%A5%E5%8F%A3/" title="二、API 开放平台-模拟接口"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-22</div><div class="title">二、API 开放平台-模拟接口</div></div></a></div><div><a href="/2022/12/22/%E5%88%9B%E5%BB%BAstarter%E6%AD%A5%E9%AA%A4/" title="创建 starter 步骤"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-22</div><div class="title">创建 starter 步骤</div></div></a></div><div><a href="/2022/12/22/%E5%9B%9B%E3%80%81API-%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0-%E7%BD%91%E5%85%B3/" title="API 开放平台四-网关"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-22</div><div class="title">API 开放平台四-网关</div></div></a></div><div><a href="/2022/12/22/%E4%B8%89%E3%80%81API%20%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0-%E6%8E%A5%E5%8F%A3%E5%8F%91%E5%B8%83/" title="三、API 开放平台-接口发布"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-22</div><div class="title">三、API 开放平台-接口发布</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://tse1-mm.cn.bing.net/th/id/OIP-C.Tli8rxBF2RBOpQg7cLTLIQHaHa?w=209&amp;h=199&amp;c=7&amp;r=0&amp;o=5&amp;dpr=1.3&amp;pid=1.7" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">墨枫</div><div class="author-info__description">墨枫个人笔记总结与分享</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">40</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/lumofeng"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/lumofeng" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Elastic-Stack"><span class="toc-number">1.</span> <span class="toc-text">Elastic Stack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-ES"><span class="toc-number">1.1.</span> <span class="toc-text">安装 ES</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Kibana"><span class="toc-number">1.2.</span> <span class="toc-text">安装 Kibana</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch-%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.</span> <span class="toc-text">ElasticSearch 概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%EF%BC%88%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%EF%BC%89"><span class="toc-number">1.3.1.</span> <span class="toc-text">索引（倒排索引）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ES%E7%9A%84%E5%87%A0%E7%A7%8D%E8%B0%83%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.</span> <span class="toc-text">ES的几种调用方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89restful-api-%E8%B0%83%E7%94%A8%EF%BC%88HTTP-%E8%AF%B7%E6%B1%82%EF%BC%89"><span class="toc-number">1.4.1.</span> <span class="toc-text">1）restful api 调用（HTTP 请求）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-kibana-devtools"><span class="toc-number">1.4.2.</span> <span class="toc-text">2)kibana devtools</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%BC%89%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B0%83%E7%94%A8"><span class="toc-number">1.4.3.</span> <span class="toc-text">3）客户端调用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ES-%E8%AF%AD%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">ES 语法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DSL"><span class="toc-number">1.5.1.</span> <span class="toc-text">DSL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E8%A1%A8%E3%80%81%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">建表、插入数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4"><span class="toc-number">1.5.1.4.</span> <span class="toc-text">删除</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EQL"><span class="toc-number">1.5.2.</span> <span class="toc-text">EQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL"><span class="toc-number">1.5.3.</span> <span class="toc-text">SQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Painless-Scripting-language"><span class="toc-number">1.5.4.</span> <span class="toc-text">Painless Scripting language</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mapping"><span class="toc-number">1.6.</span> <span class="toc-text">Mapping</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticStack-%E6%A6%82%E5%BF%B5"><span class="toc-number">1.7.</span> <span class="toc-text">ElasticStack 概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">1.7.1.</span> <span class="toc-text">分词器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IK-%E5%88%86%E8%AF%8D%E5%99%A8%EF%BC%88ES-%E6%8F%92%E4%BB%B6%EF%BC%89"><span class="toc-number">1.7.2.</span> <span class="toc-text">IK 分词器（ES 插件）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%88%86%E6%9C%BA%E5%88%B6"><span class="toc-number">1.7.3.</span> <span class="toc-text">打分机制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ES-%E8%B0%83%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">1.8.</span> <span class="toc-text">ES 调用方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-%E6%93%8D%E4%BD%9C-ES"><span class="toc-number">1.8.1.</span> <span class="toc-text">Java 操作 ES</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8-ES-%E5%AE%9E%E7%8E%B0%E6%90%9C%E7%B4%A2%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.9.</span> <span class="toc-text">用 ES 实现搜索接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%BB%BA%E8%A1%A8%EF%BC%88%E5%BB%BA%E7%AB%8B%E7%B4%A2%E5%BC%95%EF%BC%89"><span class="toc-number">1.9.1.</span> <span class="toc-text">1、建表（建立索引）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="toc-number">1.9.2.</span> <span class="toc-text">2、增删改查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%9F%A5%E8%AF%A2-DSL"><span class="toc-number">1.9.3.</span> <span class="toc-text">3、查询 DSL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">1.10.</span> <span class="toc-text">数据同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Logstash"><span class="toc-number">1.10.1.</span> <span class="toc-text">Logstash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A2%E9%98%85%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B5%81%E6%B0%B4%E7%9A%84%E5%90%8C%E6%AD%A5%E6%96%B9%E5%BC%8F-Canal"><span class="toc-number">1.10.2.</span> <span class="toc-text">订阅数据库流水的同步方式 Canal</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-kibama-%E5%8F%AF%E8%A7%86%E5%8C%96%E7%9C%8B%E6%9D%BF"><span class="toc-number">1.11.</span> <span class="toc-text">配置 kibama 可视化看板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="toc-number">1.12.</span> <span class="toc-text">压力测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E5%A4%9A%E7%9A%84%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.12.1.</span> <span class="toc-text">更多的学习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.13.</span> <span class="toc-text">搜索建议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E9%AB%98%E4%BA%AE"><span class="toc-number">1.14.</span> <span class="toc-text">搜索高亮</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E9%98%B2%E6%8A%96%E8%8A%82%E6%B5%81"><span class="toc-number">1.15.</span> <span class="toc-text">前端防抖节流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E7%A8%B3%E5%AE%9A%E6%80%A7%E4%BC%98%E5%8C%96"><span class="toc-number">1.16.</span> <span class="toc-text">接口稳定性优化</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/06/28/%E8%AF%BB%E3%80%8A%E4%BB%8A%E6%97%A5%E6%91%84%E5%BD%B1%E3%80%8B/" title="读《今日摄影》"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="读《今日摄影》"/></a><div class="content"><a class="title" href="/2023/06/28/%E8%AF%BB%E3%80%8A%E4%BB%8A%E6%97%A5%E6%91%84%E5%BD%B1%E3%80%8B/" title="读《今日摄影》">读《今日摄影》</a><time datetime="2023-06-27T16:21:53.105Z" title="发表于 2023-06-28 00:21:53">2023-06-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/03/%E4%B8%80%E3%80%81%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2%E5%B9%B3%E5%8F%B0%E7%AE%80%E4%BB%8B/" title="一、聚合搜索平台简介"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一、聚合搜索平台简介"/></a><div class="content"><a class="title" href="/2023/05/03/%E4%B8%80%E3%80%81%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2%E5%B9%B3%E5%8F%B0%E7%AE%80%E4%BB%8B/" title="一、聚合搜索平台简介">一、聚合搜索平台简介</a><time datetime="2023-05-03T15:27:51.304Z" title="发表于 2023-05-03 23:27:51">2023-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/03/%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2%E4%BC%98%E5%8C%96/" title="聚合搜索优化"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="聚合搜索优化"/></a><div class="content"><a class="title" href="/2023/05/03/%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2%E4%BC%98%E5%8C%96/" title="聚合搜索优化">聚合搜索优化</a><time datetime="2023-05-03T15:27:51.302Z" title="发表于 2023-05-03 23:27:51">2023-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/03/%E4%BA%8C%E3%80%81%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2%E5%B9%B3%E5%8F%B0%E6%95%B0%E6%8D%AE%E6%8A%93%E5%8F%96/" title="二、聚合搜索平台数据抓取"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="二、聚合搜索平台数据抓取"/></a><div class="content"><a class="title" href="/2023/05/03/%E4%BA%8C%E3%80%81%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2%E5%B9%B3%E5%8F%B0%E6%95%B0%E6%8D%AE%E6%8A%93%E5%8F%96/" title="二、聚合搜索平台数据抓取">二、聚合搜索平台数据抓取</a><time datetime="2023-05-03T15:27:51.300Z" title="发表于 2023-05-03 23:27:51">2023-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/03/Elastic-Stack/" title="Elastic Stack"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Elastic Stack"/></a><div class="content"><a class="title" href="/2023/05/03/Elastic-Stack/" title="Elastic Stack">Elastic Stack</a><time datetime="2023-05-03T15:27:51.294Z" title="发表于 2023-05-03 23:27:51">2023-05-03</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 墨枫</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'nvHykKxDkmmX1stydcNy3Um7-gzGzoHsz',
      appKey: 'Lbv3XcuwZgrp23TElZVj0efL',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>